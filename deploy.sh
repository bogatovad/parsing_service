#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

set -e

echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –∞—Ñ–∏—à–∏..."
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ—Ç–∏
if ! docker network ls | grep -q "afisha"; then
    echo "üì° –°–æ–∑–¥–∞–Ω–∏–µ Docker —Å–µ—Ç–∏ 'afisha'..."
    docker network create afisha
else
    echo "üì° –°–µ—Ç—å 'afisha' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
docker compose build

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
echo "üìÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–¥–∞—á..."
docker compose --profile init up schedule-init

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üéØ –ó–∞–ø—É—Å–∫ Celery —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker compose up -d celery-worker-parsing celery-beat-parsing

echo ""
echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìã –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
echo "  üîÑ celery-worker-parsing - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–∞—á"
echo "  ‚è∞ celery-beat-parsing - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á"
echo ""
echo "üìÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:"
echo "  üìä –ü–∞—Ä—Å–µ—Ä—ã: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 9:00 MSK"
echo "  üßπ –û—á–∏—Å—Ç–∫–∞: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:00 MSK"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
echo "  docker-compose ps"
echo "  docker-compose logs -f celery-beat-parsing"
echo ""
